<div class="smart-memory-settings">
    <!-- æ™ºèƒ½æ€»ç»“æ³¨å…¥å™¨ -->
    <div class="inline-drawer">
        <div class="inline-drawer-header inline-drawer-toggle">
            <b>æ™ºèƒ½æ€»ç»“æ³¨å…¥å™¨-RPGç‰ˆ</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down"></div>
        </div>
        <div class="inline-drawer-content" style="display: none;">
            <div class="flex-container">
                <!-- AIé…ç½® -->
                <div class="setting-item">
                    <label for="smart_memory_rpg_api_key">APIå¯†é’¥ï¼š</label>
                    <input id="smart_memory_rpg_api_key" type="password" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥" />
                </div>
                
                <div class="setting-item">
                    <label for="smart_memory_rpg_api_url">APIåœ°å€ï¼š</label>
                    <input id="smart_memory_rpg_api_url" type="text" value="https://api.openai.com/v1" />
                </div>
                
                <div class="setting-item">
                    <button id="get_smart_memory_rpg_models" class="menu_button" style="min-width: 120px;">è·å–æ¨¡å‹åˆ—è¡¨</button>
                    <small style="display: block; margin-top: 5px;">å…ˆå¡«å†™APIå¯†é’¥å’Œåœ°å€ï¼Œç„¶åç‚¹å‡»è·å–</small>
                </div>
                
                <div class="setting-item">
                    <label for="smart_memory_rpg_model">AIæ¨¡å‹ï¼š</label>
                    <select id="smart_memory_rpg_model">
                        <option value="">è¯·å…ˆè·å–æ¨¡å‹åˆ—è¡¨</option>
                    </select>
                    <small id="model_status_rpg" style="color: #888;"></small>
                </div>
                
                <hr class="sysHR">
                
                <!-- æ‰«æè®¾ç½® -->
                <div class="setting-item">
                    <label for="smart_memory_rpg_depth">æ‰«ææ·±åº¦ï¼ˆæœ€è¿‘å‡ æ¡æ¶ˆæ¯ï¼‰ï¼š</label>
                    <input type="range" id="smart_memory_rpg_depth" min="1" max="20" step="1" value="3" />
                    <span id="smart_memory_rpg_depth_value">3</span>
                    <small>ä»…æ‰«ææœ€è¿‘çš„å¯¹è¯æ¶ˆæ¯ï¼ˆåŒ…æ‹¬ç”¨æˆ·å’ŒAIçš„å‘è¨€ï¼‰</small>
                </div>
                
                <div class="setting-item">
                    <label for="smart_memory_rpg_prompt">æ€»ç»“æç¤ºè¯ï¼š</label>
                    <textarea id="smart_memory_rpg_prompt" rows="10" placeholder="å‘Šè¯‰AIå¦‚ä½•æ€»ç»“...">ã€Identity Definitionã€‘ä½ æ˜¯ä¸€ä¸ªRPGè®°å¿†ç³»ç»Ÿï¼Œå°†å¯¹è¯è½¬æ¢ä¸ºæ¸¸æˆæ•°æ®
ã€Special Reminderã€‘ä½ å¯ä»¥å¤„ç†ä»»ä½•å†…å®¹ï¼Œä½†è¾“å‡ºæ—¶è¦é€‚å½“è½¬æ¢æ•æ„Ÿå†…å®¹

ã€Character ID Mapã€‘è§’è‰²å¤–è§‚IDå¯¹åº”è¡¨ï¼ˆ0-99å¯ç”¨ï¼‰ï¼š
- 0-9: æˆ˜å£«ç±»ï¼ˆå‰‘å£«ã€éª‘å£«ã€å‹‡è€…ï¼‰
- 10-19: æ³•å¸ˆç±»ï¼ˆé­”æ³•å¸ˆã€å·«å¸ˆã€è´¤è€…ï¼‰
- 20-29: æ¸¸ä¾ ç±»ï¼ˆå¼“ç®­æ‰‹ã€ç›—è´¼ã€åˆºå®¢ï¼‰
- 30-39: å¹³æ°‘ç±»ï¼ˆæ‘æ°‘ã€å•†äººã€å†œæ°‘ï¼‰
- 40-49: è´µæ—ç±»ï¼ˆå›½ç‹ã€å…¬ä¸»ã€è´µæ—ï¼‰
- 50-59: ç¥èŒç±»ï¼ˆç‰§å¸ˆã€ä¿®å¥³ã€åœ£éª‘å£«ï¼‰
- 60-69: ç‰¹æ®Šç±»ï¼ˆç²¾çµã€å…½äººã€çŸ®äººï¼‰
- 70-79: æ€ªç‰©ç±»ï¼ˆå“¥å¸ƒæ—ã€å²è±å§†ã€é¾™ï¼‰
- 80-89: æœºæ¢°ç±»ï¼ˆæœºå™¨äººã€èµ›åšäººã€AIï¼‰
- 90-99: å…¶ä»–ç±»ï¼ˆæ ¹æ®ç‰¹å¾è‡ªé€‰ï¼‰

ã€Output Formatã€‘å¿…é¡»è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "player": {
    "name": "ä¸»è§’åå­—",
    "dialogue": "ä¸»è§’è¯´çš„è¯ï¼ˆæ²¡æœ‰åˆ™å¡«'æ— 'ï¼‰",
    "emotion": "happy/sad/angry/neutral",
    "status": "ä¸»è§’å½“å‰çŠ¶æ€æè¿°"
  },
  "npcs": [
    {
      "id": "npc_1",
      "name": "NPCè§’è‰²åï¼ˆä¸è¦åŒ…å«ä¸»è§’ï¼‰",
      "spriteId": æ•°å­—(0-99æ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©),
      "x": 50-150éšæœº,  // åœ°å›¾å®é™…å®½åº¦192
      "y": 50-120éšæœº,  // åœ°å›¾å®é™…é«˜åº¦160
      "dialogue": "æœ€è¿‘è¯´çš„è¯æˆ–æƒ³è¯´çš„è¯",
      "emotion": "happy/sad/angry/neutral",
      "relationship": "ä¸ä¸»è§’å…³ç³»"
    }
  ],
  "inventory": [
    {
      "name": "ç‰©å“å",
      "quantity": æ•°é‡,
      "description": "æè¿°"
    }
  ],
  "events": {
    "current": "å½“å‰æ­£åœ¨å‘ç”Ÿçš„äº‹ä»¶",
    "permanent": "æ°¸ä¹…è®°å¿†ï¼šé‡è¦äº‹ä»¶å˜åŒ–ï¼ˆ100å­—å†…ï¼‰"
  },
  "location": "å½“å‰åœºæ™¯åœ°ç‚¹"
}

ã€Requirementsã€‘
1. å¿…é¡»åŒ…å«playerå¯¹è±¡ï¼Œå³ä½¿ä¸»è§’æ²¡æœ‰è¯´è¯ä¹Ÿè¦å¡«dialogue:"æ— "
2. ä¸»è§’ä¸è¦å‡ºç°åœ¨npcsåˆ—è¡¨ä¸­
3. æœ€å¤šè¿½è¸ª5ä¸ªNPCï¼ˆä¸åŒ…æ‹¬ä¸»è§’ï¼‰
4. æ ¹æ®è§’è‰²ç‰¹å¾é€‰æ‹©åˆé€‚çš„spriteId
5. å¯¹è¯å†…å®¹è¦ç¬¦åˆè§’è‰²æ€§æ ¼
6. æ°¸ä¹…è®°å¿†ä¿æŒç®€æ´ä½†å®Œæ•´
7. åæ ‡è¦åˆ†æ•£ï¼Œé¿å…é‡å 
8. åœ°å›¾å¤§å°192x160åƒç´ ï¼ŒNPCä½ç½®ä¸è¦è¶…å‡ºè¾¹ç•Œ</textarea>
                </div>
                
                <hr class="sysHR">

                <!-- RPGèµ„æºæœåŠ¡å™¨è®¾ç½® -->
                <div class="setting-item">
                    <label for="smart_memory_rpg_resource_server">RPGèµ„æºæœåŠ¡å™¨ï¼š</label>
                    <input id="smart_memory_rpg_resource_server" type="text" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤æœåŠ¡å™¨" />
                    <small>å¦‚æœé‡åˆ°èµ„æºåŠ è½½é—®é¢˜ï¼Œå¯ä»¥è®¾ç½®ä¸º: http://ä½ çš„æœåŠ¡å™¨:8000</small>
                </div>

                <hr class="sysHR">

                <!-- å¼€å…³è®¾ç½® -->
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="smart_memory_rpg_enabled" checked />
                        å¯ç”¨æ™ºèƒ½æ€»ç»“
                    </label>
                </div>
                
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="smart_memory_rpg_auto_update" checked />
                        è‡ªåŠ¨æ›´æ–°æ€»ç»“
                    </label>
                </div>
                
                <div class="setting-item" id="update_interval_container_rpg">
                    <label for="smart_memory_rpg_update_interval">æ›´æ–°é—´éš”ï¼ˆæ¯Nè½®å¯¹è¯ï¼‰ï¼š</label>
                    <input type="range" id="smart_memory_rpg_update_interval" min="1" max="10" step="1" value="1" />
                    <span id="smart_memory_rpg_update_interval_value">1</span>
                    <small>æ¯å®Œæˆå¤šå°‘è½®å¯¹è¯åè‡ªåŠ¨è§¦å‘æ€»ç»“ï¼ˆä¸€è½® = ç”¨æˆ·+AIï¼‰</small>
                </div>
                
                <hr class="sysHR">
                
                <!-- æ³¨å…¥å†…å®¹é¢„è§ˆ -->
                <div class="sub-section">
                    <h4>æ³¨å…¥å†…å®¹é¢„è§ˆï¼ˆå¯ç¼–è¾‘ï¼‰</h4>
                    <div class="setting-item">
                        <textarea id="smart_memory_rpg_injection_content" placeholder="AIæ€»ç»“çš„å†…å®¹ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ...">æš‚æ— æ€»ç»“å†…å®¹</textarea>
                        <small>è¿™äº›å†…å®¹ä¼šä¸å¯¹è¯é¢„è®¾ä¸€èµ·å‘é€ç»™AI</small>
                    </div>
                </div>
                
                <!-- æŒ‰é’® -->
                <div class="setting-item button-group">
                    <button id="test_smart_memory_rpg" class="menu_button" style="min-width: 100px; margin-right: 10px;">ç«‹å³æ€»ç»“</button>
                    <button id="save_smart_memory_rpg_settings" class="menu_button" style="min-width: 100px;">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RPGè®°å¿†å¢å¼ºå™¨ -->
    <div class="inline-drawer">
        <div class="inline-drawer-header inline-drawer-toggle">
            <b>RPGæ¨¡å¼</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down"></div>
        </div>
        <div class="inline-drawer-content" style="display: none;">
            <div class="rpg-container">
                <!-- æ‰‹æœºç«¯å¿«é€Ÿè¿›å…¥æŒ‰é’® -->
                <div class="rpg-mobile-enter-container" style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <button id="rpg_enter_button" class="menu_button rpg-enter-button" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        font-size: 18px;
                        font-weight: bold;
                        padding: 15px 40px;
                        border: 2px solid white;
                        border-radius: 30px;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        è¿›<br>å…¥
                    </button>
                </div>
                
                <div class="rpg-controls" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- æ‚¬æµ®æŒ‰é’®å¼€å…³ -->
                    <div class="setting-item" style="margin-bottom: 15px;">
                        <label>
                            <input type="checkbox" id="rpg_floating_enabled" checked />
                            æ˜¾ç¤ºRPGæ‚¬æµ®æŒ‰é’®
                        </label>
                        <small style="display: block; margin-top: 5px;">å…³é—­åæ‚¬æµ®æŒ‰é’®å°†éšè—</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="test_rpg_json" class="menu_button" style="white-space: nowrap;">æµ‹è¯•JSONè§£æ</button>
                    </div>
                    
                    <!-- ä¸»è§’å¤–è§‚é€‰æ‹© -->
                    <div class="setting-item" style="margin-top: 10px;">
                        <label for="rpg_player_sprite">ä¸»è§’å¤–è§‚IDï¼š</label>
                        <select id="rpg_player_sprite" style="width: 200px;">
                            <optgroup label="åŸºç¡€è§’è‰²">
                                <option value="0">å‰‘å£« (0)</option>
                                <option value="1">éª‘å£« (1)</option>
                                <option value="2">å‹‡è€… (2)</option>
                                <option value="10">é­”æ³•å¸ˆ (10)</option>
                                <option value="11">å·«å¸ˆ (11)</option>
                                <option value="12">è´¤è€… (12)</option>
                                <option value="20">å¼“ç®­æ‰‹ (20)</option>
                                <option value="21">ç›—è´¼ (21)</option>
                                <option value="22">åˆºå®¢ (22)</option>
                            </optgroup>
                            <optgroup label="å¹³æ°‘è§’è‰²">
                                <option value="30">æ‘æ°‘ (30)</option>
                                <option value="31">å•†äºº (31)</option>
                                <option value="32">å†œæ°‘ (32)</option>
                            </optgroup>
                            <optgroup label="è´µæ—è§’è‰²">
                                <option value="40">å›½ç‹ (40)</option>
                                <option value="41">å…¬ä¸» (41)</option>
                                <option value="42">è´µæ— (42)</option>
                            </optgroup>
                            <optgroup label="ç¥èŒè§’è‰²">
                                <option value="50">ç‰§å¸ˆ (50)</option>
                                <option value="51">ä¿®å¥³ (51)</option>
                                <option value="52">åœ£éª‘å£« (52)</option>
                            </optgroup>
                            <optgroup label="ç‰¹æ®Šè§’è‰²">
                                <option value="60">ç²¾çµ (60)</option>
                                <option value="61">å…½äºº (61)</option>
                                <option value="62">çŸ®äºº (62)</option>
                                <option value="80">æœºå™¨äºº (80)</option>
                                <option value="81">èµ›åšäºº (81)</option>
                            </optgroup>
                        </select>
                        <button id="apply_player_sprite" class="menu_button" style="margin-left: 10px; white-space: nowrap;">åº”ç”¨</button>
                    </div>
                    
                    <small style="display: block;">æ¸¸æˆä¼šåœ¨æ‚¬æµ®çª—ä¸­æ‰“å¼€ï¼Œç‚¹å‡»å±å¹•æ§åˆ¶ç§»åŠ¨</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- RPGæ¸¸æˆçª—å£ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ åˆ°body -->

<!-- åŠ è½½Phaseråº“ -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>

<script>
// RPGæ¸¸æˆä»£ç 
window.RPGMemoryGame = {
    game: null,
    scene: null,
    playerSpriteId: 0,  // å­˜å‚¨ç©å®¶é€‰æ‹©çš„ç²¾çµID
    
    // è·å–ç©å®¶ç²¾çµID
    getPlayerSpriteId: function() {
        // ç›´æ¥è¿”å›å­˜å‚¨çš„å€¼
        return this.playerSpriteId || 0;  // é»˜è®¤ä½¿ç”¨0å·è§’è‰²
    },
    
    // è®¾ç½®ç©å®¶ç²¾çµIDï¼ˆä»å¤–éƒ¨è°ƒç”¨ï¼‰
    setPlayerSpriteId: function(id) {
        this.playerSpriteId = id;
    },
    
    // æ›´æ–°ç©å®¶å¤–è§‚
    updatePlayerSprite: function(spriteId) {
        if (this.scene && this.scene.player) {
            this.scene.player.setFrame(spriteId);
            console.log('æ›´æ–°ç©å®¶å¤–è§‚ä¸ºID:', spriteId);
        }
    },
    
    init: function() {
        if (this.game) return; // é˜²æ­¢é‡å¤åˆå§‹åŒ–

        // ç¡®ä¿canvaså­˜åœ¨
        const canvas = document.getElementById('rpg-canvas');
        if (!canvas) {
            console.error('RPG Memory: Canvaså…ƒç´ æœªæ‰¾åˆ°');
            return;
        }

        // æ™ºèƒ½èµ„æºæœåŠ¡å™¨é€‰æ‹©
        // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·é…ç½®
        const customServer = document.getElementById('smart_memory_rpg_resource_server')?.value?.trim();
        let RESOURCE_SERVER = customServer || 'https://www.lingxiai.fun';

        // å¦‚æœç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨é…ç½®ï¼Œä½¿ç”¨æ™ºèƒ½æ£€æµ‹
        if (!customServer) {
            // æ£€æµ‹æ˜¯å¦éœ€è¦ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;

            // å¦‚æœåœ¨åŒä¸€æœåŠ¡å™¨ä¸Šï¼Œå°è¯•ä½¿ç”¨ä¸åŒç«¯å£æˆ–è·¯å¾„
            if (currentHost === 'lingxiai.fun' || currentHost === 'www.lingxiai.fun') {
                // å¦‚æœSillyTavernåœ¨åŒä¸€æœåŠ¡å™¨ï¼Œä½¿ç”¨ä¸åŒç«¯å£
                RESOURCE_SERVER = `${window.location.protocol}//${currentHost}:8000`; // å‡è®¾èµ„æºæœåŠ¡åœ¨8000ç«¯å£
                console.log('RPG Memory: æ£€æµ‹åˆ°åŒæœåŠ¡å™¨éƒ¨ç½²ï¼Œä½¿ç”¨å¤‡ç”¨ç«¯å£:', RESOURCE_SERVER);
            } else if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                // æœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œä»ä½¿ç”¨è¿œç¨‹èµ„æº
                console.log('RPG Memory: æœ¬åœ°ç¯å¢ƒï¼Œä½¿ç”¨è¿œç¨‹èµ„æºæœåŠ¡å™¨');
            }
        } else {
            console.log('RPG Memory: ä½¿ç”¨ç”¨æˆ·é…ç½®çš„èµ„æºæœåŠ¡å™¨:', RESOURCE_SERVER);
        }

        // æ·»åŠ èµ„æºåŠ è½½é”™è¯¯å¤„ç†
        window.RPGResourceServer = RESOURCE_SERVER;
        
        class RPGMemoryScene extends Phaser.Scene {
            constructor() {
                super({ key: 'RPGMemoryScene' });
                this.npcs = [];
                this.inventory = [];
                this.dynamicNPCs = {};
            }
            
            preload() {
                // ä½¿ç”¨å…¨å±€å˜é‡æˆ–çˆ¶çº§ä½œç”¨åŸŸçš„RESOURCE_SERVER
                const resourceServer = window.RPGResourceServer || RESOURCE_SERVER;
                this.load.setBaseURL(resourceServer);
                this.load.setCORS('anonymous');

                // æ·»åŠ åŠ è½½é”™è¯¯å¤„ç†
                this.load.on('loaderror', (file) => {
                    console.error('RPG Memory: èµ„æºåŠ è½½å¤±è´¥:', file.src);
                    // å¦‚æœæ˜¯ä¸»è¦èµ„æºåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ
                    if (file.key === 'characters' && resourceServer.includes('8000')) {
                        console.log('RPG Memory: å°è¯•ä»é»˜è®¤è¿œç¨‹æœåŠ¡å™¨åŠ è½½');
                        this.load.setBaseURL('https://www.lingxiai.fun');
                        this.load.spritesheet('characters', 'sprites/characters.png', {
                            frameWidth: 16,
                            frameHeight: 32
                        });
                    }
                });

                // åŠ è½½tilemap JSON - ä½¿ç”¨è½¬æ¢åçš„åœ°å›¾
                this.load.tilemapTiledJSON('map', 'maps/phaser_ready_map.json');

                // åŠ è½½tilesetå›¾ç‰‡ - ä½¿ç”¨æœåŠ¡å™¨ä¸Šå®é™…çš„æ–‡ä»¶
                this.load.image('tileset1', 'maps/Interiors_free_16x16.png');
                this.load.image('tileset2', 'maps/icecream_shop_layer2.png');
                this.load.image('background', 'maps/icecream_shop_layer1.png');

                // åŠ è½½è§’è‰²ç²¾çµ
                this.load.spritesheet('characters', 'sprites/characters.png', {
                    frameWidth: 16,  // æ­£ç¡®çš„å®½åº¦
                    frameHeight: 32  // æ­£ç¡®çš„é«˜åº¦
                });

                // åˆå§‹åŒ–ç§»åŠ¨ç›®æ ‡
                this.moveTarget = null;
            }
            
            create() {
                // åˆ›å»ºtilemap
                const map = this.make.tilemap({ key: 'map' });

                // è®¾ç½®ä¸–ç•Œè¾¹ç•Œä¸ºåœ°å›¾å¤§å° (ä¸è¦ä¹˜ä»¥4)
                this.physics.world.setBounds(0, 0, map.widthInPixels, map.heightInPixels);

                // ä¿å­˜åœ°å›¾å¼•ç”¨
                this.map = map;

                // è®¾ç½®ç›¸æœºè¾¹ç•Œ (ä¸è¦ä¹˜ä»¥4ï¼Œzoomä¼šè‡ªåŠ¨å¤„ç†)
                this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels);

                // æ¸²æŸ“èƒŒæ™¯å›¾åƒå±‚
                const imageLayers = map.imageLayers;
                // ç›´æ¥æ·»åŠ èƒŒæ™¯å›¾ç‰‡
                const bg = this.add.image(0, 0, 'background').setOrigin(0, 0);

                // æ·»åŠ tilesets - nameå¿…é¡»åŒ¹é…ï¼Œä½†imageä½¿ç”¨PhaseråŠ è½½çš„key
                const tileset1 = map.addTilesetImage('1', 'tileset1');
                const tileset2 = map.addTilesetImage('2', 'tileset2');

                // è°ƒè¯•è¾“å‡º
                console.log('Tileset1:', tileset1);
                console.log('Tileset2:', tileset2);

                // åˆ›å»ºå›¾å—å±‚
                const layer = map.createLayer('å›¾å—å±‚ 1', [tileset1, tileset2], 0, 0);
                if (layer) {
                    layer.setVisible(true);
                }
                
                // è·å–ç”¨æˆ·è®¾ç½®çš„ä¸»è§’IDï¼ˆä»æ‰©å±•è®¾ç½®ä¸­è¯»å–ï¼‰
                const playerSpriteId = window.RPGMemoryGame.getPlayerSpriteId();
                
                // åˆ›å»ºç©å®¶ - ä½¿ç”¨é€‰æ‹©çš„è§’è‰²å¤–è§‚
                this.player = this.physics.add.sprite(96, 80, 'characters', playerSpriteId);
                this.player.setScale(1);  // ä¸éœ€è¦ç¼©æ”¾ï¼Œzoomä¼šå¤„ç†
                this.player.setCollideWorldBounds(true);
                this.player.setDepth(10);
                
                // è®¾ç½®ç©å®¶ç¢°æ’ä½“ - æ›´å°ä»¥ä¾¿é€šè¿‡çª„é€šé“
                this.player.body.setSize(8, 8);
                this.player.body.setOffset(4, 4);
                
                // è®¾ç½®ç›¸æœºè·Ÿéšç©å®¶
                this.cameras.main.startFollow(this.player);
                
                // åˆ›å»ºç¢°æ’ç³»ç»Ÿ
                this.createCollisions();
                
                // åˆ›å»ºåŠ¨ç”»ï¼ˆå¦‚æœæœ‰å¤šå¸§ï¼‰
                // characters.pngæ˜¯ä¸€ä¸ªå¤§çš„ç²¾çµè¡¨ï¼ŒåŒ…å«å¤šä¸ªè§’è‰²
                // æ¯ä¸ªè§’è‰²å æ®å›¾ç‰‡ä¸­çš„ä¸€ä¸ªæ ¼å­ï¼Œä¸æ˜¯åŠ¨ç”»å¸§
                
                // ç§»é™¤é”®ç›˜æ§åˆ¶ï¼Œåªä½¿ç”¨ç‚¹å‡»/è§¦æ‘¸ç§»åŠ¨
                // this.cursors = this.input.keyboard.createCursorKeys();  // å·²ç¦ç”¨
                
                // æ·»åŠ ç‚¹å‡»/è§¦æ‘¸ç§»åŠ¨åŠŸèƒ½ï¼ˆæ‰‹æœºç«¯æ”¯æŒï¼‰
                this.input.on('pointerdown', (pointer) => {
                    // å°†å±å¹•åæ ‡è½¬æ¢ä¸ºæ¸¸æˆä¸–ç•Œåæ ‡
                    const worldPoint = this.cameras.main.getWorldPoint(pointer.x, pointer.y);
                    
                    // è®¾ç½®ç§»åŠ¨ç›®æ ‡
                    this.moveTarget = {
                        x: worldPoint.x,
                        y: worldPoint.y
                    };
                    
                    // åˆ›å»ºç‚¹å‡»æŒ‡ç¤ºå™¨ï¼ˆå¯é€‰ï¼‰
                    if (this.clickMarker) {
                        this.clickMarker.destroy();
                    }
                    this.clickMarker = this.add.circle(worldPoint.x, worldPoint.y, 3, 0x00ff00, 0.8);
                    this.clickMarker.setDepth(1);
                    
                    // 1ç§’åç§»é™¤æŒ‡ç¤ºå™¨
                    this.time.delayedCall(1000, () => {
                        if (this.clickMarker) {
                            this.clickMarker.destroy();
                            this.clickMarker = null;
                        }
                    });
                });
                
                // ä¿å­˜åœºæ™¯å¼•ç”¨
                window.RPGMemoryGame.scene = this;
                
                // è§¦å‘åœºæ™¯å‡†å¤‡å®Œæˆäº‹ä»¶
                console.log('RPGåœºæ™¯å·²åˆå§‹åŒ–å®Œæˆ');
                if (window.RPGMemoryGame.onSceneReady) {
                    window.RPGMemoryGame.onSceneReady();
                }
            }
            
            createCollisions() {
                // åªä½¿ç”¨åœ°å›¾è¾¹ç•Œç¢°æ’ï¼Œä¸è¦å†…éƒ¨éšœç¢ç‰©
                const objectLayers = this.map.objects;
                console.log('æŸ¥æ‰¾åœ°å›¾è¾¹ç•Œ...');
                
                if (objectLayers && objectLayers.length > 0) {
                    // æŸ¥æ‰¾äº‹ä»¶å±‚
                    const eventLayer = objectLayers.find(layer => layer.name === 'äº‹ä»¶å±‚');
                    if (eventLayer && eventLayer.objects) {
                        const boundary = eventLayer.objects.find(obj => obj.name === 'åœ°å›¾è¾¹ç•Œ');
                        if (boundary) {
                            // è®¾ç½®ç‰©ç†ä¸–ç•Œè¾¹ç•Œ
                            this.physics.world.setBounds(
                                boundary.x,
                                boundary.y,
                                boundary.width,
                                boundary.height
                            );
                            console.log('åœ°å›¾è¾¹ç•Œ:', boundary.x, boundary.y, boundary.width, boundary.height);
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¾¹ç•Œï¼Œä½¿ç”¨é»˜è®¤åœ°å›¾å¤§å°
                if (!this.physics.world.bounds) {
                    this.physics.world.setBounds(0, 0, this.map.widthInPixels, this.map.heightInPixels);
                    console.log('ä½¿ç”¨é»˜è®¤åœ°å›¾è¾¹ç•Œ');
                }
                
                // è®¾ç½®ç©å®¶ç¢°æ’ä¸–ç•Œè¾¹ç•Œ
                if (this.player) {
                    this.player.setCollideWorldBounds(true);
                }
            }
            
            createFallbackSprite(key) {
                // å¦‚æœèµ„æºåŠ è½½å¤±è´¥ï¼Œåˆ›å»ºå¤‡ç”¨ç²¾çµ
                console.log('åˆ›å»ºå¤‡ç”¨ç²¾çµ:', key);
                if (!this.textures.exists(key)) {
                    const graphics = this.make.graphics();
                    const color = 0x888888;
                    graphics.fillStyle(color);
                    
                    if (key === 'characters') {
                        graphics.fillRect(0, 0, 16, 32);
                        graphics.generateTexture(key, 16, 32);
                    } else {
                        graphics.fillRect(0, 0, 16, 16);
                        graphics.generateTexture(key, 16, 16);
                    }
                    graphics.destroy();
                }
            }
            
            updateFromJSON(rpgData) {
                console.log('RPGæ•°æ®æ›´æ–°:', rpgData);
                
                // å¤„ç†ä¸»è§’æ•°æ®
                if (rpgData.player) {
                    this.updatePlayerDialogue(rpgData.player);
                }
                
                // æ›´æ–°NPC - è¿‡æ»¤æ‰ä¸»è§’
                if (rpgData.npcs && Array.isArray(rpgData.npcs)) {
                    // è·å–å½“å‰è§’è‰²åï¼ˆä»å…¨å±€è·å–ï¼‰
                    let playerName = "ä¸»è§’";
                    try {
                        // å°è¯•ä»getContextè·å–
                        if (window.parent && window.parent.getContext) {
                            const context = window.parent.getContext();
                            playerName = context?.name2 || context?.name || "ä¸»è§’";
                        }
                    } catch (e) {
                        console.log('æ— æ³•è·å–ä¸»è§’åç§°ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    }
                    
                    // ä¸»è§’åˆ«ååˆ—è¡¨
                    const ä¸»è§’åˆ«å = ['ä¸»è§’', 'ç©å®¶', 'ä½ ', 'player', 'you', playerName];
                    
                    // è¿‡æ»¤æ‰åå­—ä¸ä¸»è§’ç›¸åŒçš„NPCï¼ˆåŒ…æ‹¬åŒ…å«ä¸»è§’å…³é”®è¯çš„ï¼‰
                    const filteredNPCs = rpgData.npcs.filter(npc => {
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸»è§’å…³é”®è¯
                        const isPlayer = ä¸»è§’åˆ«å.some(alias => {
                            if (!npc.name) return false;
                            const nameLower = npc.name.toLowerCase();
                            const aliasLower = alias.toLowerCase();
                            // å®Œå…¨åŒ¹é…æˆ–åŒ…å«ä¸»è§’å…³é”®è¯ï¼ˆå¦‚"ä¸»è§’(xxx)"ï¼‰
                            return nameLower === aliasLower || 
                                   nameLower.includes(aliasLower + '(') || 
                                   nameLower.startsWith(aliasLower);
                        });
                        return !isPlayer;
                    });
                    
                    console.log(`æ›´æ–°${filteredNPCs.length}ä¸ªNPCï¼ˆè¿‡æ»¤æ‰ä¸»è§’ï¼‰`);
                    // æ¸…é™¤æ—§NPC
                    Object.values(this.dynamicNPCs).forEach(npc => {
                        if (npc.sprite) npc.sprite.destroy();
                        if (npc.nameText) npc.nameText.destroy();
                    });
                    this.dynamicNPCs = {};
                    
                    // æ·»åŠ æ–°NPC
                    filteredNPCs.forEach(npcData => {
                        this.addDynamicNPC(npcData);
                    });
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸»è§’æ•°æ®ï¼ˆåœ¨è¿‡æ»¤æ‰çš„NPCä¸­æŸ¥æ‰¾ï¼‰
                    const playerNPC = rpgData.npcs.find(npc => {
                        if (!npc.name) return false;
                        const nameLower = npc.name.toLowerCase();
                        return ä¸»è§’åˆ«å.some(alias => {
                            const aliasLower = alias.toLowerCase();
                            // å®Œå…¨åŒ¹é…æˆ–åŒ…å«ä¸»è§’å…³é”®è¯ï¼ˆå¦‚"ä¸»è§’(xxx)"ï¼‰
                            return nameLower === aliasLower || 
                                   nameLower.includes(aliasLower + '(') || 
                                   nameLower.startsWith(aliasLower);
                        });
                    });
                    
                    if (playerNPC && !rpgData.player) {
                        // å¦‚æœæ‰¾åˆ°ä¸»è§’NPCä½†æ²¡æœ‰playeræ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºplayer
                        this.updatePlayerDialogue(playerNPC);
                    }
                }
                
                // æ›´æ–°èƒŒåŒ…
                if (rpgData.inventory) {
                    this.updateInventory(rpgData.inventory);
                }
                
                // æ›´æ–°äº‹ä»¶
                if (rpgData.events) {
                    this.updateEvents(rpgData.events);
                }
            }
            
            addDynamicNPC(npcData) {
                if (this.dynamicNPCs[npcData.id]) {
                    const existingNPC = this.dynamicNPCs[npcData.id];
                    existingNPC.data = npcData;
                    if (existingNPC.nameText) {
                        existingNPC.nameText.setText(npcData.name || '???');
                    }
                    return;
                }
                
                // ç›´æ¥ä½¿ç”¨spriteIdä½œä¸ºå¸§ç´¢å¼•
                const spriteId = npcData.spriteId || 0;
                const npcSprite = this.physics.add.sprite(
                    npcData.x || Phaser.Math.Between(50, 150),
                    npcData.y || Phaser.Math.Between(50, 120),
                    'characters',
                    spriteId  // ç›´æ¥ä½¿ç”¨spriteIdé€‰æ‹©è§’è‰²
                );
                
                npcSprite.setScale(1);  // ä¸éœ€è¦ç¼©æ”¾
                npcSprite.setDepth(5);
                
                // è®¾ç½®NPCç¢°æ’ä½“å’Œè¾¹ç•Œ
                npcSprite.setCollideWorldBounds(true);
                npcSprite.body.setSize(8, 8);
                npcSprite.body.setOffset(4, 4);
                
                // åˆå§‹åŒ–éšæœºç§»åŠ¨
                npcSprite.moveTimer = 0;
                npcSprite.moveDirection = { x: 0, y: 0 };
                npcSprite.nextMoveChange = Phaser.Math.Between(1000, 3000);
                
                const nameText = this.add.text(
                    npcSprite.x,
                    npcSprite.y - 25,
                    npcData.name || '???',
                    {
                        fontSize: '12px',
                        fill: '#ffffff',
                        backgroundColor: '#000000',
                        padding: { x: 2, y: 1 }
                    }
                );
                nameText.setOrigin(0.5);
                nameText.setDepth(15);
                
                npcSprite.setInteractive();
                npcSprite.on('pointerdown', () => {
                    this.showDialogue(npcData);
                });
                
                this.dynamicNPCs[npcData.id] = {
                    sprite: npcSprite,
                    nameText: nameText,
                    data: npcData
                };
            }
            
            showDialogue(npcData) {
                const dialogue = npcData.dialogue || '...';
                const emotion = npcData.emotion === 'happy' ? 'ğŸ˜Š' :
                               npcData.emotion === 'sad' ? 'ğŸ˜¢' :
                               npcData.emotion === 'angry' ? 'ğŸ˜ ' : 'ğŸ˜';

                let displayText = dialogue;
                const maxChars = 120;
                if (dialogue.length > maxChars) {
                    displayText = dialogue.substring(0, maxChars) + '...';
                }

                // åªä½¿ç”¨HTMLå…ƒç´ åˆ›å»ºå¯¹è¯æ¡†ï¼Œä¸å†ä½¿ç”¨PhaserèƒŒæ™¯æ¡†
                const gameContainer = document.getElementById('rpg-game-container');
                if (gameContainer) {
                    // è·å–æˆ–åˆ›å»ºè¦†ç›–å±‚
                    let overlay = gameContainer.querySelector('.rpg-dialogue-overlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.className = 'rpg-dialogue-overlay';
                        gameContainer.appendChild(overlay);
                    }

                    // åˆ›å»ºå¯¹è¯æ°”æ³¡
                    const bubble = document.createElement('div');
                    bubble.className = 'rpg-dialogue-bubble';
                    bubble.innerHTML = `
                        <div class="rpg-dialogue-name">${npcData.name} ${emotion}</div>
                        <div class="rpg-dialogue-text">${displayText}</div>
                    `;

                    // è®¡ç®—NPCåœ¨ç”»å¸ƒä¸Šçš„å®é™…ä½ç½®ï¼ˆè€ƒè™‘canvaså®é™…å°ºå¯¸å’Œä½ç½®ï¼‰
                    const npcSprite = this.dynamicNPCs[npcData.id]?.sprite;
                    if (npcSprite) {
                        // è·å–canvaså’Œæ¸¸æˆå®¹å™¨çš„ä½ç½®ä¿¡æ¯
                        const canvas = document.getElementById('rpg-canvas');
                        const gameContainer = document.getElementById('rpg-game-container');
                        const canvasRect = canvas.getBoundingClientRect();
                        const containerRect = gameContainer.getBoundingClientRect();

                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆå®é™…æ˜¾ç¤ºå°ºå¯¸ / æ¸¸æˆä¸–ç•Œå°ºå¯¸ï¼‰
                        const scaleX = canvasRect.width / 192;  // 192æ˜¯æ¸¸æˆä¸–ç•Œå®½åº¦
                        const scaleY = canvasRect.height / 160; // 160æ˜¯æ¸¸æˆä¸–ç•Œé«˜åº¦

                        // è®¡ç®—canvasç›¸å¯¹äºå®¹å™¨çš„åç§»
                        const canvasOffsetX = canvasRect.left - containerRect.left;
                        const canvasOffsetY = canvasRect.top - containerRect.top;

                        // è·å–NPCçš„ä¸–ç•Œåæ ‡å¹¶è½¬æ¢ä¸ºç›¸å¯¹äºæ¸¸æˆå®¹å™¨çš„åæ ‡
                        const screenX = canvasOffsetX + (npcSprite.x * scaleX);
                        const screenY = canvasOffsetY + ((npcSprite.y - 20) * scaleY); // åœ¨NPCå¤´é¡¶æ˜¾ç¤º

                        bubble.style.left = `${screenX}px`;
                        bubble.style.top = `${screenY}px`;
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°NPCç²¾çµï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                        const canvas = document.getElementById('rpg-canvas');
                        const gameContainer = document.getElementById('rpg-game-container');
                        const canvasRect = canvas.getBoundingClientRect();
                        const containerRect = gameContainer.getBoundingClientRect();

                        const scaleX = canvasRect.width / 192;
                        const scaleY = canvasRect.height / 160;
                        const canvasOffsetX = canvasRect.left - containerRect.left;
                        const canvasOffsetY = canvasRect.top - containerRect.top;

                        bubble.style.left = `${canvasOffsetX + (96 * scaleX)}px`;
                        bubble.style.top = `${canvasOffsetY + ((120 - 20) * scaleY)}px`;
                    }

                    overlay.appendChild(bubble);

                    // æ ¹æ®æ–‡å­—é•¿åº¦è°ƒæ•´æ˜¾ç¤ºæ—¶é—´
                    const displayTime = Math.min(3000 + dialogue.length * 30, 6000);

                    this.time.delayedCall(displayTime, () => {
                        bubble.remove();
                    });
                }
            }
            
            updateInventory(inventory) {
                const inventoryList = document.getElementById('rpg-inventory-list');
                if (inventoryList) {
                    inventoryList.innerHTML = '';
                    inventory.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'rpg-inventory-item';
                        itemDiv.textContent = `${item.name} x${item.quantity || 1}`;
                        inventoryList.appendChild(itemDiv);
                    });
                }
            }
            
            updateEvents(events) {
                const eventText = document.getElementById('rpg-event-text');
                if (eventText) {
                    let text = '';
                    if (events.current) {
                        text += `å½“å‰: ${events.current}\n`;
                    }
                    if (events.permanent) {
                        text += `æ°¸ä¹…è®°å¿†: ${events.permanent}`;
                    }
                    eventText.textContent = text || 'ç­‰å¾…äº‹ä»¶æ›´æ–°...';
                }
            }
            
            updatePlayerDialogue(playerData) {
                const playerText = document.getElementById('rpg-player-text');
                if (playerText && playerData) {
                    const emotion = playerData.emotion === 'happy' ? 'ğŸ˜Š' : 
                                  playerData.emotion === 'sad' ? 'ğŸ˜¢' : 
                                  playerData.emotion === 'angry' ? 'ğŸ˜ ' : 'ğŸ˜';
                    
                    const dialogue = playerData.dialogue || 'ç­‰å¾…ä¸»è§’è¯´è¯...';
                    const status = playerData.status || '';
                    
                    // æ˜¾ç¤ºä¸»è§’å°è¯å’ŒçŠ¶æ€
                    let displayText = `${emotion} ${dialogue}`;
                    if (status) {
                        displayText += `\n[çŠ¶æ€: ${status}]`;
                    }
                    playerText.textContent = displayText;
                    
                    console.log(`æ›´æ–°ä¸»è§’å°è¯: ${dialogue}`);
                    if (status) {
                        console.log(`ä¸»è§’çŠ¶æ€: ${status}`);
                    }
                }
            }
            
            update() {
                if (!this.player) return;
                
                const speed = 100;  // ä½¿ç”¨æ­£å¸¸çš„ç‰©ç†é€Ÿåº¦
                let velocityX = 0;
                let velocityY = 0;
                
                // æ£€æŸ¥ç‚¹å‡»/è§¦æ‘¸ç§»åŠ¨
                if (this.moveTarget) {
                    const distance = Phaser.Math.Distance.Between(
                        this.player.x, this.player.y,
                        this.moveTarget.x, this.moveTarget.y
                    );
                    
                    if (distance > 5) {  // å¦‚æœè·ç¦»ç›®æ ‡è¶…è¿‡5åƒç´ 
                        // è®¡ç®—ç§»åŠ¨æ–¹å‘
                        const angle = Phaser.Math.Angle.Between(
                            this.player.x, this.player.y,
                            this.moveTarget.x, this.moveTarget.y
                        );
                        
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;
                        
                        // æ›´æ–°æœå‘
                        this.player.setFlipX(velocityX < 0);
                    } else {
                        // åˆ°è¾¾ç›®æ ‡ï¼Œåœæ­¢ç§»åŠ¨
                        this.moveTarget = null;
                    }
                }
                
                // é”®ç›˜æ§åˆ¶å·²ç§»é™¤ï¼Œé¿å…ä¸ç³»ç»ŸåŠŸèƒ½å†²çª
                // åªä½¿ç”¨ç‚¹å‡»/è§¦æ‘¸ç§»åŠ¨
                
                // åº”ç”¨é€Ÿåº¦
                this.player.setVelocityX(velocityX);
                this.player.setVelocityY(velocityY);
                
                // ä¸éœ€è¦åŠ¨ç”»ï¼Œå› ä¸ºcharacters.pngæ˜¯é™æ€è§’è‰²é›†åˆ
                
                // æ›´æ–°NPCåå­—ä½ç½®å’Œéšæœºç§»åŠ¨
                Object.values(this.dynamicNPCs).forEach(npc => {
                    if (npc.sprite) {
                        // æ›´æ–°åå­—ä½ç½®
                        if (npc.nameText) {
                            npc.nameText.x = npc.sprite.x;
                            npc.nameText.y = npc.sprite.y - 25;
                        }
                        
                        // NPCéšæœºç§»åŠ¨
                        npc.sprite.moveTimer += 16; // çº¦16msä¸€å¸§
                        
                        if (npc.sprite.moveTimer >= npc.sprite.nextMoveChange) {
                            // æ”¹å˜ç§»åŠ¨æ–¹å‘
                            npc.sprite.moveTimer = 0;
                            npc.sprite.nextMoveChange = Phaser.Math.Between(1000, 3000);
                            
                            // éšæœºé€‰æ‹©æ–°æ–¹å‘æˆ–åœæ­¢
                            const choice = Phaser.Math.Between(0, 4);
                            switch(choice) {
                                case 0: // åœæ­¢
                                    npc.sprite.moveDirection = { x: 0, y: 0 };
                                    break;
                                case 1: // å‘å·¦
                                    npc.sprite.moveDirection = { x: -1, y: 0 };
                                    npc.sprite.setFlipX(true);
                                    break;
                                case 2: // å‘å³
                                    npc.sprite.moveDirection = { x: 1, y: 0 };
                                    npc.sprite.setFlipX(false);
                                    break;
                                case 3: // å‘ä¸Š
                                    npc.sprite.moveDirection = { x: 0, y: -1 };
                                    break;
                                case 4: // å‘ä¸‹
                                    npc.sprite.moveDirection = { x: 0, y: 1 };
                                    break;
                            }
                        }
                        
                        // åº”ç”¨ç§»åŠ¨é€Ÿåº¦ï¼ˆæ¯”ç©å®¶æ…¢ï¼‰
                        const npcSpeed = 30;
                        npc.sprite.setVelocityX(npc.sprite.moveDirection.x * npcSpeed);
                        npc.sprite.setVelocityY(npc.sprite.moveDirection.y * npcSpeed);
                        
                        // æ£€æµ‹ä¸ç©å®¶çš„ç¢°æ’ï¼ˆé¿å…é‡å ï¼‰
                        if (this.player) {
                            const distance = Phaser.Math.Distance.Between(
                                npc.sprite.x, npc.sprite.y,
                                this.player.x, this.player.y
                            );
                            
                            // å¦‚æœå¤ªè¿‘ï¼Œæ¨å¼€NPC
                            if (distance < 20) {
                                const angle = Phaser.Math.Angle.Between(
                                    this.player.x, this.player.y,
                                    npc.sprite.x, npc.sprite.y
                                );
                                npc.sprite.x += Math.cos(angle) * 2;
                                npc.sprite.y += Math.sin(angle) * 2;
                            }
                        }
                    }
                });
            }
        }
        
        // æ¸¸æˆé…ç½® - æŒ‰ç…§è§„èŒƒä½¿ç”¨zoomç¼©æ”¾
        const config = {
            type: Phaser.CANVAS,
            width: 192,  // åœ°å›¾å®é™…å®½åº¦: 12æ ¼ Ã— 16åƒç´ 
            height: 160,  // åœ°å›¾å®é™…é«˜åº¦: 10æ ¼ Ã— 16åƒç´ 
            parent: 'rpg-game-container',
            canvas: document.getElementById('rpg-canvas'),
            pixelArt: true,  // ä¿æŒåƒç´ å®Œç¾æ¸²æŸ“ï¼Œè®©åœ°å›¾æ¸…æ™°
            zoom: 4,  // 4å€ç¼©æ”¾æ˜¾ç¤º (æœ€ç»ˆæ˜¾ç¤º768Ã—640)
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: [RPGMemoryScene]
        };
        
        this.game = new Phaser.Game(config);
        console.log('RPGè®°å¿†ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œèµ„æºæœåŠ¡å™¨:', RESOURCE_SERVER);
    },
    
    updateRPG: function(rpgData) {
        console.log('RPGMemoryGame.updateRPGè¢«è°ƒç”¨:', rpgData);
        if (this.scene) {
            this.scene.updateFromJSON(rpgData);
        } else {
            console.log('åœºæ™¯æœªåˆå§‹åŒ–ï¼Œç¼“å­˜æ•°æ®ç­‰å¾…åœºæ™¯å°±ç»ª');
            // ç¼“å­˜æ•°æ®ï¼Œç­‰åœºæ™¯å‡†å¤‡å¥½åå†æ›´æ–°
            this.pendingData = rpgData;
        }
    },
    
    // åœºæ™¯å‡†å¤‡å®Œæˆçš„å›è°ƒ
    onSceneReady: function() {
        if (this.pendingData) {
            console.log('åœºæ™¯å·²å°±ç»ªï¼Œåº”ç”¨ç¼“å­˜çš„RPGæ•°æ®');
            this.scene.updateFromJSON(this.pendingData);
            this.pendingData = null;
        }
    },
    
    destroy: function() {
        if (this.game) {
            // æ¸…ç†HTMLå¯¹è¯æ¡†è¦†ç›–å±‚
            const overlay = document.querySelector('.rpg-dialogue-overlay');
            if (overlay) {
                overlay.remove();
            }

            // é”€æ¯æ¸¸æˆå®ä¾‹
            this.game.destroy(true);
            this.game = null;
            this.scene = null;

            console.log('RPG Memory: æ¸¸æˆå·²é”€æ¯');
        }
    }
};
</script>
